{{ define "title" }}{{ or .Params.artist_name .Title }} | {{ .Site.Title }}{{ end }}
{{ define "main" }}
<main class="single-post container">
  <article class="single-article">
    <section class="single-hero">
      <aside class="single-hero-info">
        <div class="now-playing-info">
          {{ $hasResident := isset .Params "is_resident" }}
          {{ $isResident := cond $hasResident .Params.is_resident true }}
          {{ $name := (or .Params.artist_name .Title) }}
          <h1 class="show-title">{{ $name }}</h1>
          {{ if $isResident }}
            <p class="single-artists">Resident Artist</p>
          {{ else }}
            <p class="single-artists">Guest Artist</p>
          {{ end }}

          <div class="show-description">{{ .Content }}</div>
        </div>
      </aside>
      {{ with .Params.image }}
      <div class="single-hero-image">
        <img src="{{ . | relURL }}" alt="{{ (or $.Params.artist_name $.Title) }}" />
      </div>
      {{ end }}
    </section>

  </article>
  
  {{/* Past shows for this artist */}}
  {{ $artistName := (or .Params.artist_name .Title) }}
  {{ $artistKey := $artistName | urlize }}
  {{ $now := now }}
  {{ $pastShows := where (where .Site.RegularPages "Section" "post") "Date" "<" $now }}
  {{ $matches := slice }}
  {{ range $pastShows }}
    {{ $p := . }}
    {{ $hasMatch := false }}
    {{ with .Params.artist }}
      {{ if eq (urlize .) $artistKey }}
        {{ $hasMatch = true }}
      {{ end }}
    {{ end }}
    {{ if not $hasMatch }}
      {{ with .Params.artists }}
        {{ range . }}
          {{ if eq (urlize .) $artistKey }}
            {{ $hasMatch = true }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if not $hasMatch }}
      {{ with .Params.show_name }}
        {{ if eq (urlize .) $artistKey }}
          {{ $hasMatch = true }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if $hasMatch }}
      {{ $matches = $matches | append $p }}
    {{ end }}
  {{ end }}

  <section class="recent-section container">
    <h2 class="recent-heading page-title">Past shows</h2>
    {{ if gt (len $matches) 0 }}
      <div class="recent-posts">
        {{ range (sort $matches "Date" "desc") }}
          {{ $p := . }}
          {{ $showtime := .Params.showtime }}
          {{ $hasResident := isset .Params "is_resident" }}
          {{ $isResident := cond $hasResident .Params.is_resident true }}
          {{ $artists := .Params.artists }}
          {{ if not $artists }}{{ $artists = slice (or .Params.show_name .Title) }}{{ end }}
          {{ $artistsStr := partial "format-artists.html" (dict "artists" $artists) }}
          {{ $showName := .Params.show_name }}
          {{ $title := (or $showName .Title) }}
          {{ $displayTitle := cond (and (not $isResident) (not $showName)) $artistsStr $title }}
          {{ if or (and $showtime (ne $showtime "")) (and $displayTitle (ne $displayTitle "")) }}
          <article class="recent-post">
            {{ with .Params.image }}
            <img
              class="recent-post-img"
              src="{{ . | relURL }}"
              alt="{{ $displayTitle }}"
            />
            {{ end }}
            <div class="recent-post-content">
              <div class="upcoming-meta">
                <span class="upcoming-pill upcoming-pill-date">{{ .Date.Format "Mon, 02 Jan" }}</span>
              </div>
              <h3 class="recent-title">{{ $displayTitle }}</h3>
              {{ if $isResident }}
                <p class="recent-artists">with {{ $artistsStr }}</p>
              {{ else }}
                <p class="recent-artists">Guestmix</p>
              {{ end }}
              <div class="post-tags">
                {{ with .Params.tags }} {{ range first 4 . }}<span class="post-tag">{{ . }}</span>{{ end }} {{ end }}
              </div>
            </div>
            <a class="card-link" href="{{ .RelPermalink }}" aria-label="Open {{ $displayTitle }}"></a>
          </article>
          {{ end }}
        {{ end }}
      </div>
    {{ else }}
      <p>No past shows yet for {{ $artistName }}.</p>
    {{ end }}
  </section>
</main>
{{ end }}
