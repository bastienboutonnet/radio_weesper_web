{{ define "title" }}Artists | {{ .Site.Title }}{{ end }}
{{ define "main" }}
<main class="archive-page container">
  <section class="recent-section container">
    <h2 class="recent-heading page-title">All Artists</h2>
  {{ $artists := where .Site.RegularPages "Section" "artist" }}
  {{ $sorted := sort $artists (slice "Params.artist_name" "Title") }}

    {{/* Full alphabet (Aâ€“Z) plus '#' bucket */}}
    {{ $alphabet := slice "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S" "T" "U" "V" "W" "X" "Y" "Z" "#" }}

    {{/* Count artists per letter using Scratch to avoid scope issues */}}
    {{ range $sorted }}
      {{ $displayName := or .Params.artist_name (or .Title .File.BaseFileName) }}
      {{ $raw := trim $displayName " \t\r\n" }}
      {{ $slug := anchorize $raw }}
      {{ $first := "#" }}
      {{ if ne $slug "" }}
        {{ $first = upper (substr $slug 0 1) }}
      {{ end }}
      {{ $.Scratch.Add (printf "letter-%s" $first) 1 }}
    {{ end }}

  <div id="alpha-sentinel" aria-hidden="true"></div>
  <nav class="alpha-index" aria-label="Alphabetical index">
      <ul class="alpha-index-list">
        {{ range $alphabet }}
          {{ $count := $.Scratch.Get (printf "letter-%s" .) }}
          {{ $has := and $count (gt $count 0) }}
          <li>
            {{ if $has }}
              <a href="#{{ . }}" class="post-tag">{{ . }}</a>
            {{ else }}
              <span class="post-tag" aria-disabled="true">{{ . }}</span>
            {{ end }}
          </li>
        {{ end }}
      </ul>
  </nav>

  <div id="alpha-spacer"></div>

  {{ range $alphabet }}
      {{ $count := $.Scratch.Get (printf "letter-%s" .) }}
      {{ if and $count (gt $count 0) }}
  <h3 id="{{ . }}" class="alpha-heading">{{ . }}</h3>
      <div class="recent-posts">
        {{ $letter := . }}
        {{ range $sorted }}
          {{ $displayName := or .Params.artist_name (or .Title .File.BaseFileName) }}
          {{ $raw := trim $displayName " \t\r\n" }}
          {{ $slug := anchorize $raw }}
          {{ $first := "#" }}
          {{ if ne $slug "" }}
            {{ $first = upper (substr $slug 0 1) }}
          {{ end }}
          {{ if eq $first $letter }}
            {{ $hasResident := isset .Params "is_resident" }}
            {{ $isResident := cond $hasResident .Params.is_resident true }}
            <article class="recent-post">
              {{ with .Params.image }}
              <img class="recent-post-img" src="{{ . | relURL }}" alt="{{ $displayName }}" />
              {{ end }}
              <div class="recent-post-content">
                <h3 class="recent-title">{{ $displayName }}</h3>
                {{ if $isResident }}
                  <p class="recent-artists">Resident Artist</p>
                {{ else }}
                  <p class="recent-artists">Guest Artist</p>
                {{ end }}
              </div>
              <a class="card-link" href="{{ .RelPermalink }}" aria-label="Open {{ $displayName }}"></a>
            </article>
          {{ end }}
        {{ end }}
      </div>
      {{ end }}
    {{ end }}

    <script>
      (function(){
        const bar = document.querySelector('.alpha-index');
        const spacer = document.getElementById('alpha-spacer');
        const sentinel = document.getElementById('alpha-sentinel');
        if (!bar || !spacer || !sentinel) return;

        function barHeight(){
          const h = bar.getBoundingClientRect().height;
          return h > 0 ? h : 60;
        }

        const fix = () => {
          bar.style.position = 'fixed';
          bar.style.top = '0px';
          bar.style.zIndex = '1002';
          spacer.style.height = barHeight() + 'px';
        };
        const unfix = () => {
          bar.style.position = '';
          bar.style.top = '';
          bar.style.zIndex = '';
          spacer.style.height = '0px';
        };

        const io = new IntersectionObserver(([e]) => {
          if (!e) return;
          if (e.isIntersecting) {
            unfix();
          } else {
            fix();
          }
        }, {rootMargin: '0px 0px 0px 0px', threshold: 0});
        io.observe(sentinel);

        window.addEventListener('resize', () => {
          if (bar.style.position === 'fixed') spacer.style.height = barHeight() + 'px';
        });
      })();
    </script>
  </section>
</main>
{{ end }}
