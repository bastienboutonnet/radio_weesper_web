<section class="schedule-section">
  <div class="schedule-header-row">
    <h2 class="schedule-title">Schedule</h2>
  </div>
  <div class="schedule-timezone">Timezone: Amsterdam (CEST)</div>
  <!-- <hr class="schedule-divider" /> -->
  {{/* Get all posts in the next 3 weeks */}}
  {{ $now := now }}
  {{ $end := $now.AddDate 0 0 21 }}
  {{ $shows := where (where .Site.Pages "Section" "post") "Date" ">=" $now }}
  {{ $shows := where $shows "Date" "<" $end }}
  {{/* Sort by date ascending so we can take the next three days */}}
  {{ $showsSorted := sort $shows "Date" }}
  {{ $days := slice }}
  {{ range $showsSorted }}
    {{ $day := .Date.Format "Mon, 02 Jan" }}
    {{ if not (in $days $day) }}
      {{ $days = $days | append $day }}
    {{ end }}
  {{ end }}
  {{/* Limit to the next 3 distinct days */}}
  {{ $daysToShow := first 3 $days }}
  <div class="schedule-grid-wrap">
  <div class="schedule-grid">
    {{ range $i, $day := $daysToShow }}
      {{/* Split $day into parts: day name, digits, month */}}
      {{ $parts := split $day ", " }}
      {{ $dayName := index $parts 0 }}
      {{ $rest := index $parts 1 }}
      {{ $restParts := split $rest " " }}
      {{ $dayDigits := index $restParts 0 }}
      {{ $month := index $restParts 1 }}
      <div class="schedule-day-column">
        <div class="schedule-day-pill">{{ $dayName }}, {{ $dayDigits }} {{ $month }}</div>
        <ul class="schedule-shows">
          {{ $showsForDay := slice }}
          {{ range $showsSorted }}
            {{ if eq (.Date.Format "Mon, 02 Jan") $day }}
              {{ $showsForDay = $showsForDay | append . }}
            {{ end }}
          {{ end }}
          {{ range sort $showsForDay "Params.showtime" }}
            {{ $showtime := .Params.showtime }}
            {{ $hasResident := isset .Params "is_resident" }}
            {{ $isResident := cond $hasResident .Params.is_resident true }}
            {{ $artists := .Params.artists }}
            {{ if not $artists }}{{ $artists = slice (or .Params.show_name .Title) }}{{ end }}
            {{ $artistsStr := partial "format-artists.html" (dict "artists" $artists) }}
            {{ $showName := .Params.show_name }}
            {{ $title := (or $showName .Title) }}
            {{ $displayTitle := cond (and (not $isResident) (not $showName)) $artistsStr $title }}
            {{ if or (and $showtime (ne $showtime "")) (and $displayTitle (ne $displayTitle "")) }}
              <li class="schedule-show">
                <span class="schedule-show-time">
                  {{- if .Params.showendtime -}}
                    {{ .Params.showtime }} - {{ .Params.showendtime }}
                  {{- else -}}
                    {{ .Params.showtime }}
                  {{- end -}}
                </span>
                <span class="schedule-show-title">
                  <a href="{{ .RelPermalink }}">{{ $displayTitle | title }}</a>
                  {{ if $isResident }}
                    <span class="schedule-show-meta">with {{ $artistsStr }}</span>
                  {{ else }}
                    <span class="schedule-show-meta">Guestmix</span>
                  {{ end }}
                </span>
              </li>
            {{ end }}
          {{ end }}
        </ul>
      </div>
    {{ end }}
  </div>
  </div>
</section>
