<section class="schedule-section">
  <div class="schedule-header-row">
    <h2 class="schedule-title">Schedule</h2>
  </div>
  <div class="schedule-timezone">Timezone: Amsterdam (CEST)</div>
  <!-- <hr class="schedule-divider" /> -->
  {{/* Get all posts in the next 3 weeks */}}
  {{ $now := now }}
  {{ $end := $now.AddDate 0 0 21 }}
  {{ $shows := where (where .Site.Pages "Section" "post") "Date" ">=" $now }}
  {{ $shows := where $shows "Date" "<" $end }}
  {{ $days := slice }}
  {{ range $shows }}
    {{ $day := .Date.Format "Mon, 02 Jan" }}
    {{ if not (in $days $day) }}
      {{ $days = $days | append $day }}
    {{ end }}
  {{ end }}
  {{/* Limit to at most 3 distinct future days */}}
  {{ $daysToShow := $days }}
  {{ if gt (len $days) 3 }}
    {{ $daysToShow = last 3 $days }}
  {{ end }}
  <div class="schedule-grid-wrap">
  <div class="schedule-grid">
    {{ $daysCount := len $daysToShow }}
    {{ range $i, $v := $daysToShow }}
      {{ $revIndex := sub (sub $daysCount $i) 1 }}
      {{ $day := index $daysToShow $revIndex }}
      {{/* Split $day into parts: day name, digits, month */}}
      {{ $parts := split $day ", " }}
      {{ $dayName := index $parts 0 }}
      {{ $rest := index $parts 1 }}
      {{ $restParts := split $rest " " }}
      {{ $dayDigits := index $restParts 0 }}
      {{ $month := index $restParts 1 }}
      <div class="schedule-day-column">
        <div class="schedule-day-pill">{{ $dayName }}, {{ $dayDigits }} {{ $month }}</div>
        <ul class="schedule-shows">
          {{ $showsForDay := slice }}
          {{ range $shows }}
            {{ if eq (.Date.Format "Mon, 02 Jan") $day }}
              {{ $showsForDay = $showsForDay | append . }}
            {{ end }}
          {{ end }}
          {{ range sort $showsForDay "Params.showtime" }}
            {{ $showtime := .Params.showtime }}
            {{ $title := (or .Params.show_name .Title) }}
            {{ if or (and $showtime (ne $showtime "")) (and $title (ne $title "")) }}
              <li class="schedule-show">
                <span class="schedule-show-time">
                  {{- if .Params.showendtime -}}
                    {{ .Params.showtime }} - {{ .Params.showendtime }}
                  {{- else -}}
                    {{ .Params.showtime }}
                  {{- end -}}
                </span>
                <span class="schedule-show-title">
                  <a href="{{ .RelPermalink }}" style="text-transform: uppercase; font-weight: 700; color: #181a1b;">{{ with .Params.show_name }}{{ . }}{{ else }}{{ .Title }}{{ end }}</a>
                </span>
              </li>
            {{ end }}
          {{ end }}
        </ul>
      </div>
    {{ end }}
  </div>
  </div>
</section>
