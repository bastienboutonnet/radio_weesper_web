<section class="player-section">
  <div class="player">
    <!-- Little Streamer minimal HLS player -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
      .ls-player {
        position: relative;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        aspect-ratio: 16 / 9;
      }

      .ls-player video {
        display: block;
        width: 100%;
        height: 100%;
        background: #000;
        object-fit: contain;
      }

      .ls-player button {
        position: absolute;
        top: 12px;
        left: 12px;
        padding: 10px 16px;
        border: none;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        font: 600 0.9rem/1.2 system-ui, sans-serif;
        letter-spacing: 0.04em;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .ls-player button:hover,
      .ls-player button:focus-visible {
        background: rgba(30, 136, 229, 0.75);
        outline: none;
      }

      .ls-player-status {
        margin: 12px 0 0;
        font: 500 0.85rem/1.4 system-ui, sans-serif;
        letter-spacing: 0.02em;
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
      }

      .player-section {
        height: auto !important;
        min-height: 0;
        align-items: stretch;
      }

      .player {
        display: flex;
        justify-content: center;
        align-items: stretch;
      }

      .now-playing {
        height: auto;
        box-sizing: border-box;
      }

    </style>

    <div class="ls-player">
      <video
        id="little-streamer-player"
        playsinline
        autoplay
        muted
        preload="auto"
      ></video>
      <button type="button" id="ls-audio-toggle" aria-pressed="false">
        START LISTENING
      </button>
      <p id="ls-player-status" class="ls-player-status" aria-live="polite"></p>
    </div>

    <script>
      (function () {
        const streamUrl = 'https://littlestreamer.bastienboutonnet.nl/live/master.m3u8';
        const video = document.getElementById('little-streamer-player');
        const toggle = document.getElementById('ls-audio-toggle');
        const statusEl = document.getElementById('ls-player-status');
        const playerContainer = document.querySelector('.ls-player');
        let hlsInstance;
        let retryTimer;
        let retryCount = 0;
        let heightObserver;

        const MAX_DELAY = 60000;
        const BASE_DELAY = 15000;

        const setStatus = (message) => {
          if (statusEl) {
            statusEl.textContent = message || '';
          }
        };

        const ensurePlaying = () => {
          if (video.paused) {
            const playPromise = video.play();
            if (playPromise && typeof playPromise.catch === 'function') {
              playPromise.catch(() => {
                /* autoplay policy may block until user gesture */
              });
            }
          }
        };
        
        video.controls = false;
        video.addEventListener('pause', ensurePlaying);
        video.addEventListener('ended', ensurePlaying);

        const clearRetry = () => {
          if (retryTimer) {
            clearTimeout(retryTimer);
            retryTimer = null;
          }
        };

        const scheduleRetry = (reason) => {
          clearRetry();

          if (hlsInstance) {
            hlsInstance.destroy();
            hlsInstance = null;
          }

          const nextAttempt = retryCount + 1;
          const delay = Math.min(BASE_DELAY * nextAttempt, MAX_DELAY);
          const seconds = Math.round(delay / 1000);
          const message = reason
            ? `Stream unavailable (${reason}). Retrying in ${seconds}s…`
            : `Stream unavailable. Retrying in ${seconds}s…`;
          setStatus(message);
          syncPanelHeight();

          retryTimer = setTimeout(() => {
            retryCount = nextAttempt;
            startHls(true);
          }, delay);
        };

        const updateToggleUi = () => {
          const listening = !video.muted;
          toggle.textContent = listening ? 'MUTE AUDIO' : 'START LISTENING';
          toggle.setAttribute('aria-pressed', listening ? 'true' : 'false');
        };

        const setAspectRatioFromVideo = () => {
          if (!playerContainer) {
            return;
          }

          const width = video.videoWidth;
          const height = video.videoHeight;
          if (!width || !height) {
            return;
          }

          playerContainer.style.aspectRatio = `${width} / ${height}`;
          syncPanelHeight();
        };

        const syncPanelHeight = () => {
          const playerSection = toggle.closest('.player-section');
          if (!playerSection) {
            return;
          }

          const playerWrapper = playerSection.querySelector('.player');
          const playerSurface = playerSection.querySelector('.ls-player');
          const nowPlaying = playerSection.querySelector('.now-playing');

          if (!playerWrapper || !playerSurface || !nowPlaying) {
            return;
          }

          const isStackedLayout = window.matchMedia('(max-width: 700px)').matches;
          if (isStackedLayout) {
            nowPlaying.style.height = '';
            nowPlaying.style.maxHeight = '';
            nowPlaying.style.overflowY = '';
            return;
          }

          const playerHeight = playerSurface.getBoundingClientRect().height;
          if (playerHeight > 0) {
            nowPlaying.style.height = playerHeight + 'px';
            nowPlaying.style.maxHeight = playerHeight + 'px';
            nowPlaying.style.overflowY = 'auto';
          }
        };

        toggle.addEventListener('click', () => {
          video.muted = !video.muted;
          if (!video.muted) {
            video.volume = 1;
            ensurePlaying();
          }
          updateToggleUi();
          syncPanelHeight();
        });

        video.addEventListener('volumechange', updateToggleUi);

        const startHls = (isRetry = false) => {
          clearRetry();

          if (!isRetry) {
            retryCount = 0;
          }

          setStatus(isRetry ? 'Reconnecting to stream…' : 'Connecting to stream…');

          if (hlsInstance) {
            hlsInstance.destroy();
            hlsInstance = null;
          }

          video.removeAttribute('src');
          video.load();

          if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = streamUrl;
            video.addEventListener('loadedmetadata', () => {
              retryCount = 0;
              setStatus('');
              ensurePlaying();
              setAspectRatioFromVideo();
            }, { once: true });
            ensurePlaying();
            return;
          }

          if (window.Hls && Hls.isSupported()) {
            hlsInstance = new Hls({
              startPosition: -1,
              liveSyncDurationCount: 3,
              liveMaxLatencyDurationCount: 6,
              lowLatencyMode: false,
              backBufferLength: 0,
              capLevelToPlayerSize: true
            });
            hlsInstance.loadSource(streamUrl);
            hlsInstance.attachMedia(video);
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
              retryCount = 0;
              setStatus('');
              ensurePlaying();
              setAspectRatioFromVideo();
            });
            hlsInstance.on(Hls.Events.ERROR, (_event, data) => {
              if (!data) {
                return;
              }

              if (data.fatal) {
                if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                  const reason = data.response && data.response.code ? `HTTP ${data.response.code}` : 'network error';
                  scheduleRetry(reason);
                } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                  try {
                    hlsInstance.recoverMediaError();
                  } catch (_err) {
                    scheduleRetry('media error');
                  }
                } else {
                  scheduleRetry('playback error');
                }
              }
            });
          } else {
            console.error('HLS.js is not supported in this browser.');
          }
        };

        startHls();
        ensurePlaying();
        updateToggleUi();
        syncPanelHeight();
        video.addEventListener('loadedmetadata', setAspectRatioFromVideo);

        video.addEventListener('error', () => {
          const code = video.error && video.error.code ? `code ${video.error.code}` : 'unknown error';
          scheduleRetry(code);
        });

        const mediaResizeObserver = () => {
          if (heightObserver) {
            return;
          }

          if (!('ResizeObserver' in window)) {
            window.addEventListener('resize', syncPanelHeight);
            return;
          }

          const measuringElement = toggle
            .closest('.player-section')
            ?.querySelector('.ls-player');
          if (!measuringElement) {
            return;
          }

          heightObserver = new ResizeObserver(syncPanelHeight);
          heightObserver.observe(measuringElement);
        };

        mediaResizeObserver();
        window.addEventListener('resize', syncPanelHeight);
      })();
    </script>
  </div>
  {{ $now := now }}
  {{ $upcoming := sort (where (where .Site.RegularPages "Section" "post") "Date" ">=" $now) "Date" "asc" }}
  {{ $next := cond (gt (len $upcoming) 0) (index $upcoming 0) nil }}
  {{ if not $next }}
    {{ $past := sort (where (where .Site.RegularPages "Section" "post") "Date" "<" $now) "Date" "desc" }}
    {{ if gt (len $past) 0 }}
      {{ $next = (index $past 0) }}
    {{ end }}
  {{ end }}
  {{ with $next }}
  <aside class="now-playing">
    <div class="now-playing-info">
      {{ $hasResident := isset .Params "is_resident" }}
      {{ $isResident := cond $hasResident .Params.is_resident true }}
      {{ $artists := .Params.artists }}
      {{ if not $artists }}{{ $artists = slice (or .Params.show_name .Title) }}{{ end }}
      {{ $artistsStr := partial "format-artists.html" (dict "artists" $artists) }}
      {{ $showName := .Params.show_name }}
      {{ $title := (or $showName .Title) }}
      {{ $displayTitle := cond (and (not $isResident) (not $showName)) $artistsStr $title }}
  <h3 class="show-title"><a class="show-title-link" href="{{ .RelPermalink }}" aria-label="Open {{ $displayTitle }}">{{ $displayTitle }}</a></h3>
      {{ if $isResident }}
        <p class="now-playing-artists">with {{ $artistsStr }}</p>
      {{ else }}
        <p class="now-playing-artists">Guestmix</p>
      {{ end }}
      {{ if and .Params.showtime .Params.showendtime }}
      <p class="show-time">
        {{ .Params.showtime }} - {{ .Params.showendtime }}
      </p>
      {{ else if .Params.showtime }}
      <p class="show-time">{{ .Params.showtime }}</p>
      {{ else if .Params.showendtime }}
      <p class="show-time">{{ .Params.showendtime }}</p>
      {{ end }} {{ if .Params.description }}
      <p class="show-description">{{ .Params.description }}</p>
      {{ else }}
      <p class="show-description">{{ .Summary }}</p>
      {{ end }}
      <div class="post-tags" style="margin-top: auto">
        {{ with .Params.tags }} {{ range first 4 . }}<span class="post-tag"
          >{{ . }}</span
        >{{ end }} {{ end }}
      </div>
    </div>
  </aside>
  {{ else }}
  <aside class="now-playing">
    <h2 class="now-playing-heading">Now Playing</h2>
    <p class="show-description">
      No show yet. Add a post in <code>content/post/</code>.
    </p>
  </aside>
  {{ end }}
</section>
